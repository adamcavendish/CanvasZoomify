/*! canvaszoomify 2016-01-10 */
!function(a,b,c,d){"use strict";function e(a,b){this.config=$.extend({},e.DEFAULTS,b,"object"==typeof b&&b),this.isDebug=this.config.isDebug,this.canvasWidth=i(this.config,"width"),this.canvasHeight=i(this.config,"height"),this.offsetX=i(this.config,"offsetX"),this.offsetY=i(this.config,"offsetY"),this.scale=i(this.config,"scale"),this.scaleStep=i(this.config,"scaleStep"),this.scaleMax=this.config.scaleMax,this.isDebug&&console.log("CanvasZoomify Debug: ",this.isDebug),this.$element=$(a),this.$canvas=$("<canvas></canvas>"),this.$canvas.appendTo(this.$element),this.canvas=this.$canvas[0],this.canvas.width=this.canvasWidth,this.canvas.height=this.canvasHeight,this.context=this.canvas.getContext("2d"),this.tileManager=new f(this,this.config),this.imageLevel=-1,this.touchEventManager=new Hammer(this.canvas),this.touchEventManager.get("pan").set({direction:Hammer.DIRECTION_ALL}),this.touchEventManager.get("pinch").set({enable:!0}),_.each(["tap","doubletap","press","swipe"],function(a){this.touchEventManager.get(a).set({enable:!1})}.bind(this)),this.mouseState={isMouseDown:!1,mouseMoveLastX:null,mouseMoveLastY:null},this.touchState={touchPanLastX:null,touchPanLastY:null,touchPinchLastScale:null},this.init(),this.config.afterInit(),this.trigger("cz_update"),this.trigger("cz_clear"),this.trigger("cz_repaint")}function f(a,b){this.canvasZoomify=a,this.config=b,this.isDebug=this.config.isDebug,this.isDebug&&console.log("TileManager Debug: ",this.isDebug),this.levelValues=i(this.config,"levelValues"),this.rowsPerLevel=i(this.config,"rowsPerLevel"),this.colsPerLevel=i(this.config,"colsPerLevel"),this.tileWidth=i(this.config,"tileWidth"),this.tileHeight=i(this.config,"tileHeight"),this.tilesBasePath=i(this.config,"tilesBasePath"),this.tileNamePrefix=i(this.config,"tileNamePrefix"),this.tileImageType=i(this.config,"tileImageType"),this.tilesList=this.config.tiles,(_.isNull(this.tilesList)||_.isUndefined(this.tilesList))&&(this.tilesList=function(){return _.map(this.levelValues,function(a){return _.map(_.range(0,this.rowsPerLevel*a),function(b){return _.map(_.range(0,this.colsPerLevel*a),function(c){return g("{0}/{1}/{2}-{3}-{4}-{5}.{6}",this.tilesBasePath,a,this.tileNamePrefix,a,b,c,this.tileImageType)}.bind(this))}.bind(this))}.bind(this))}.bind(this)()),this.isDebug&&console.log("tilesList: ",this.tilesList),this.tilesCache={},this._rowsAtLevel=_.map(this.levelValues,function(a){return a*this.rowsPerLevel}.bind(this)),this._colsAtLevel=_.map(this.levelValues,function(a){return a*this.colsPerLevel}.bind(this)),this._tileWidthAtLevel=_.map(this.levelValues,function(a){return-1}),this._tileHeightAtLevel=_.map(this.levelValues,function(a){return-1}),this._tileSuggestionCache=function(){return _.map(this.levelValues,function(a){return _.map(_.range(a*this.rowsPerLevel*a*this.colsPerLevel),function(a){return-1})}.bind(this))}.bind(this)(),this._uniquePaintId=null,this._tileRequireNum=null,this._requireRepaint=!1}var g=function(a){var b=Array.prototype.slice.call(arguments,1);return a.replace(/{(\d+)}/g,function(a,c){return"undefined"!=typeof b[c]?b[c]:a})},h=function(a,b,c){return Math.min(Math.max(a,b),c)},i=function(a,b){var c=a[b];if(_.isNull(c)||_.isUndefined(c))throw new Error("CanvasZoomify TileManager: config "+b+" is required!");return c},j=function(a,b){a.isDefaultPrevented()&&b.preventDefault(),a.isImmediatePropagationStopped()&&b.stopImmediatePropagation(),a.isPropagationStopped()&&b.stopPropagation()};e.DEFAULTS={isDebug:!1,levelValues:null,rowsPerLevel:null,colsPerLevel:null,tileWidth:null,tileHeight:null,tilesBasePath:null,tileNamePrefix:null,tileImageType:"jpg",tiles:null,width:640,height:480,offsetX:0,offsetY:0,scale:0,scaleStep:1.1,scaleMax:16,afterInit:function(){},onCz_update:function(a){},onCz_clear:function(a){},onCz_repaint:function(a){},onPanstart:function(a){},onPanmove:function(a){},onPinchstart:function(a){},onPinch:function(a){},onMousedown:function(a){},onMouseup:function(a){},onMousemove:function(a){},onMousewheel:function(a,b){},onDOMMouseScroll:function(a,b){}},e.EVENTS={cz_update:"custom",cz_clear:"custom",cz_repaint:"custom",panstart:"multitouch",panmove:"multitouch",pinchstart:"multitouch",pinch:"multitouch",mousedown:"mouse",mouseup:"mouse",mousemove:"mouse",mousewheel:"mouse",DOMMouseScroll:"mouse"},e.prototype.trigger=function(a){this.isDebug&&console.log("trigger: ",a,arguments),$(this).trigger.apply($(this),arguments)},e.prototype._mousePosX=function(a){var b=0;return a.layerX||0===a.layerX?b=a.layerX-this.canvas.offsetLeft:(a.offsetX||0===a.offsetX)&&(b=a.offsetX),b},e.prototype._mousePosY=function(a){var b=0;return a.layerY||0===a.layerY?b=a.layerY-this.canvas.offsetTop:(a.offsetY||0===a.offsetY)&&(b=a.offsetY),b},e._getHandlerName=function(a){var b="on"+a.charAt(0).toUpperCase()+a.slice(1);return this.isDebug&&console.log("_getHandlerName",b),b},e._getDefaultHandlerName=function(a){var b=this._getHandlerName(a)+"_default";return this.isDebug&&console.log("_getDefaultHandlerName: ",b),b},e.prototype._initEvents=function(){_.each(e.EVENTS,function(a,b,c){var a=e.EVENTS[b];if("custom"==a)$(this).on(b,this._getInitEvents_custom(b));else if("multitouch"==a)this.touchEventManager.on(b,this._getInitEvents_multitouch(b)),$(this).on(b,this._getInitEvents_multitouch(b));else{if("mouse"!=a)throw new Error("CanvasZoomify: Unknown event `"+b+"`");this.canvas.addEventListener(b,this._getInitEvents_mouse(b)),$(this).on(b,this._getInitEvents_mouse(b))}}.bind(this))},e.prototype._getInitEvents_custom=function(a){return function(b){var c=Array.prototype.slice.call(arguments,1);c.unshift(b);var d=e._getHandlerName(a),f=this.config[d];if(f&&f.apply(this.config,c),!b.isDefaultPrevented()){var g=e._getDefaultHandlerName(a),h=this[g];h&&h.apply(this,c)}}.bind(this)},e.prototype._getInitEvents_mouse=function(a){return function(b){var c=!0,d=Array.prototype.slice.call(arguments,1),f=$.extend({},b,$.Event(a));d.unshift(f);var g=this.config[e._getHandlerName(a)];if(g){var h=g.apply(this.config,d);0==h&&(c=!1)}if(j(f,b),f.isDefaultPrevented())return b.preventDefault(),c;var i=this[e._getDefaultHandlerName(a)];if(i){var k=i.apply(this,d);1==c&&0==k&&(c=!1)}return j(f,b),c}.bind(this)},e.prototype._getInitEvents_multitouch=function(a){return function(b){var c=!0,d=Array.prototype.slice.call(arguments,1),f=$.extend({},b,$.Event(a));d.unshift(f);var g=this.config[e._getHandlerName(a)];if(g){var h=g.apply(this.config,d);0==h&&(c=!1)}if(j(f,b),f.isDefaultPrevented())return b.preventDefault(),c;var i=this[e._getDefaultHandlerName(a)];if(i){var k=i.apply(this,d);1==c&&0==k&&(c=!1)}return j(f,b),c}.bind(this)},e.prototype.init=function(a){this._initEvents()},e.prototype.onCz_update_default=function(a){if(0==this.scale){var b=this.tileManager.tileWidth,c=this.tileManager.tileHeight,d=this.tileManager.rowsPerLevel,e=this.tileManager.colsPerLevel,f=this.canvasWidth/(b*e),i=this.canvasHeight/(c*d);i>f?(this.scale=f,this.offsetY=Math.round((this.canvasHeight-f*c*d)/2)):(this.scale=i,this.offsetX=Math.round((this.canvasWidth-i*b*e)/2))}var j=_.findIndex(this.tileManager.levelValues,function(a){return a>=this.scale}.bind(this));-1==j&&(j=this.tileManager.levelValues.length-1),this.imageLevel=j,null!=this.scaleMax&&this.scale>this.scaleMax&&(this.scale=this.scaleMax);var k=this.scale/this.tileManager.levelValues[j],l=Math.round(this.tileManager._tileWidthAtLevel[j]*k),m=Math.round(this.tileManager._tileHeightAtLevel[j]*k),n=this.tileManager._rowsAtLevel[j],o=this.tileManager._colsAtLevel[j],p=l*o,q=m*n,r=null,s=null,t=null,u=null;-1==l||-1==m||(p<this.canvasWidth?(r=-p,t=this.canvasWidth):(r=this.canvasWidth-p,t=0),this.offsetX=h(this.offsetX,r,t),q<this.canvasHeight?(s=-q,u=this.canvasHeight):(s=this.canvasHeight-q,u=0),this.offsetY=h(this.offsetY,s,u)),this.isDebug&&(console.log(g("onCz_update_default: offset clamp (({0},{1}),({2},{3}))",r,t,s,u)),console.log(g("onCz_update_default: level {0}, offset ({1},{2}), scale {3}, scaleMax {4}",this.imageLevel,this.offsetX,this.offsetY,this.scale,this.scaleMax)))},e.prototype.onCz_clear_default=function(a){this.isDebug&&console.log("onCz_clear_default"),this.context.save(),this.context.setTransform(1,0,0,1,0,0),this.context.fillStyle="#fff",this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.context.restore()},e.prototype.onCz_repaint_default=function(a){var b=this.imageLevel,c=this.scale/this.tileManager.levelValues[b],d=Math.round(this.tileManager.tileWidth*c),e=Math.round(this.tileManager.tileHeight*c),f=this.tileManager._rowsAtLevel[b],i=this.tileManager._colsAtLevel[b],j=h(-Math.ceil(this.offsetY/e),0,f),k=h(-Math.ceil(this.offsetX/d),0,i),l=h(Math.ceil((this.canvasHeight-this.offsetY)/e),0,f),m=h(Math.ceil((this.canvasWidth-this.offsetX)/d),0,i);this.isDebug&&(console.log("onCz_repaint_default"),console.log(g("Image Info: offset ({0},{1}), scale {2}",this.offsetX,this.offsetY,this.scale)),console.log(g("Repaint: tileWidth/Height ({0},{1}), tileRowStart/End: ({2},{3}), tileColStart/End: ({4},{5})",d,e,j,l,k,m))),this.tileManager.drawTileAtLevel(this.context,b,j,k,l,m,this.offsetX,this.offsetY,c)},e.prototype.onPanstart_default=function(a){this.isDebug&&console.log("onPanstart_default");var b=a.center,c=b.x,d=b.y;this.touchState.touchPanLastX=c,this.touchState.touchPanLastY=d},e.prototype.onPanmove_default=function(a){if("mouse"!=a.pointerType){var b=a.center,c=b.x,d=b.y;_.isNull(this.touchState.touchPanLastX)||_.isNull(this.touchState.touchPanLastY)||(this.offsetX+=c-this.touchState.touchPanLastX,this.offsetY+=d-this.touchState.touchPanLastY),this.touchState.touchPanLastX=c,this.touchState.touchPanLastY=d,this.trigger("cz_update"),this.trigger("cz_clear"),this.trigger("cz_repaint")}},e.prototype.onPinchstart_default=function(a){this.isDebug&&console.log("onPinchstart_default"),this.touchState.touchPinchLastScale=1},e.prototype.onPinch_default=function(a,b){var c=null,d=100;if(b)c=Math.abs(b);else{var e=a.scale,f=e/this.touchState.touchPinchLastScale;c=f>1?1+this.scaleStep*f/d:1/(1+this.scaleStep/f/d)}return this.scale*=c,this.offsetX=Math.floor(this.offsetX*c),this.offsetY=Math.floor(this.offsetY*c),this.isDebug&&console.log(g("onPinch_default: offset ({0},{1}), scale {2}, delta scale: {3}",this.offsetX,this.offsetY,this.scale,c)),this.trigger("cz_update"),this.trigger("cz_clear"),this.trigger("cz_repaint"),a.preventDefault&&a.preventDefault(),!1},e.prototype.onMousedown_default=function(a){this.mouseState.isMouseDown=!0,this.mouseState.mouseMoveLastX=this._mousePosX(a),this.mouseState.mouseMoveLastY=this._mousePosY(a),this.isDebug&&console.log("onMousedown_default: ",this.mouseState)},e.prototype.onMouseup_default=function(a){this.mouseState.isMouseDown=!1,this.isDebug&&console.log("onMouseup_default: ",this.mouseState)},e.prototype.onMousemove_default=function(a){if(this.mouseState.isMouseDown){var b=this._mousePosX(a),c=this._mousePosY(a),d=this.offsetX+(b-this.mouseState.mouseMoveLastX),e=this.offsetY+(c-this.mouseState.mouseMoveLastY);this.mouseState.mouseMoveLastX=b,this.mouseState.mouseMoveLastY=c,this.offsetX=d,this.offsetY=e,this.trigger("cz_update"),this.trigger("cz_clear"),this.trigger("cz_repaint"),this.isDebug&&console.log("onMousemove_default: ",this.mouseState)}},e.prototype.onMousewheel_default=function(a,b){var c=function(a){var b=null;return"wheelDelta"in a?b=a.wheelDelta:a.detail&&(b=-40*a.detail),-b/120},d=null;if(b)d=Math.abs(b);else{var e=c(a);if(_.isNull(e))throw new Error("Cannot extract Mouse Wheel Delta value!");var f=this.scaleStep*Math.abs(e);d=0>e?f:1/f}return this.scale*=d,this.offsetX=Math.floor(this.offsetX*d),this.offsetY=Math.floor(this.offsetY*d),this.isDebug&&console.log(g("onMousewheel_default: offset ({0},{1}), scale {2}, delta scale: {3}",this.offsetX,this.offsetY,this.scale,d)),this.trigger("cz_update"),this.trigger("cz_clear"),this.trigger("cz_repaint"),a.preventDefault&&a.preventDefault(),!1},e.prototype.onDOMMouseScroll_default=e.prototype.onMousewheel_default,f.prototype._getTileSuggestion=function(a,b,c){return this._tileSuggestionCache[a][b*this._colsAtLevel[a]+c]},f.prototype._setTileSuggestion=function(a,b,c,d){this._tileSuggestionCache[a][b*this._colsAtLevel[a]+c]=d},f.prototype._tileOnLoadHandler=function(a,b,c){var d=this._getTileSuggestion(a,b,c);if(!(d>=a)){var e=function(a,b,c){if(!(0>=a)){var d=Math.floor(b/2),f=Math.floor(c/2),g=this._getTileSuggestion(a-1,d,f),h=[this._getTileSuggestion(a,2*d,2*f),this._getTileSuggestion(a,2*d,2*f+1),this._getTileSuggestion(a,2*d+1,2*f),this._getTileSuggestion(a,2*d+1,2*f+1)],i=_.min(h);i!=g&&(this._setTileSuggestion(a-1,d,f,i),e(a-1,d,f))}}.bind(this);this._tileSuggestionCache[a][b*this._colsAtLevel[a]+c]=a,e(a,b,c)}},f.prototype.isTileLoaded=function(a,b,c){var d=""+a+"-"+b+"-"+c,e=this.tilesCache[d];return e?0==e?2:0:1},f.prototype.getTile=function(a,b,c){var d=""+a+"-"+b+"-"+c;return 0!=this.isTileLoaded(a,b,c)?null:this.tilesCache[d]},f.prototype.loadTileFromDisk=function(a,b,c,d){this.isDebug&&console.log(g("loadTileFromDisk: {0}-{1}-{2}",a,b,c));var e=new Image;e.onload=function(){-1==this._tileWidthAtLevel[a]&&(this._tileWidthAtLevel[a]=e.width,this._tileHeightAtLevel[a]=e.height);var f=""+a+"-"+b+"-"+c;this.tilesCache[f]=e,this._tileOnLoadHandler(a,b,c),d&&d(e,a,b,c)}.bind(this),e.src=this.tilesList[a][b][c]},f.prototype.generateUniquePaintId=function(){return Date.now()},f.prototype.drawTileScaled=function(a,b,c,d,e){if(!_.isNull(b)&&!_.isUndefined(b)){var f=b.width*e,g=b.height*e;a.drawImage(b,c,d,f,g),this.isDebug&&(a.save(),a.strokeStyle="#ff0000",a.strokeRect(c,d,f,g),a.fillStyle="rgba(255, 0, 0, 0.3)",a.fillRect(c,d,f,g),a.restore())}},f.prototype.drawTileAtLevel=function(a,b,c,d,e,f,h,i,j){this.isDebug&&console.log(g("drawTileAtLevel: level {0}, rowStart/End ({1},{2}), colStart/End ({3},{4}), offset ({5},{6}), scale {7}",b,c,e,d,f,h,i,j));var k=function(b,c,d){if(--this._tileRequireNum,0==this._requireRepaint){var e=this.getTile(b,c,d),f=e.width*j*d,g=e.height*j*c;this.drawTileScaled(a,e,f+h,g+i,j)}}.bind(this),l=function(a,b,c){this.loadTileFromDisk(a,b,c,function(a,b,c,d,e){return this._uniquePaintId!=a?void(this.isDebug&&console.log(g("ignore a loadTile: expected({0}) != actual({1})",a,this._uniquePaintId))):(--this._tileRequireNum,this._requireRepaint=!0,void(1==this._requireRepaint&&0==this._tileRequireNum&&this.canvasZoomify.trigger("cz_repaint")))}.bind(this,this._uniquePaintId))}.bind(this);this._uniquePaintId=this.generateUniquePaintId(),this._tileRequireNum=(e-c)*(f-d),this._requireRepaint=!1;for(var m=c;e>m;++m)for(var n=d;f>n;++n){var o=this.isTileLoaded(b,m,n);if(0==o)k(b,m,n);else if(1==o)l(b,m,n);else if(2!=o)throw new Error("Unexpected tile state: ",o)}},"function"==typeof define&&define.amd?define(function(){return e}):"undefined"!=typeof module&&module.exports?module.exports=e:a[c]=e}(window,document,"CanvasZoomify");